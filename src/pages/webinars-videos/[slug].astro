---
import Layout from "@/layouts/Layout.astro";
import WebinarDetailHeroSection from "@/components/webinars/WebinarDetailHeroSection.vue";
import WebinarDetail from "@/components/webinars/WebinarDetail.vue";
import WebinarAuthorWrapper from "@/components/webinars/WebinarAuthorWrapper.vue";
import fetchApi from "@/utils/strapi";
import { fetchWebinar } from "@/utils/cache";

export async function getStaticPaths() {
  try {
    const response = (await fetchWebinar()) || {};

    const webinars = response || [];

    // Filter out webinars without valid slugs
    return webinars
      .filter((webinar) => webinar.slug) // Only include webinars with slugs
      .map((webinar) => ({
        params: {
          slug: webinar.slug.toString(), // Ensure slug is a string
        },
        props: { webinar },
      }));
  } catch (error) {
    console.error("Error fetching webinars:", error);
    return []; // Return empty array if there's an error
  }
}

const { webinar } = Astro.props;
const { slug } = Astro.params;

// Handle case where webinar is not found
if (!webinar) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

const mappedWebinar = {
  ...webinar,
  author:
    webinar.authors?.map((author) => ({
      name: author.name,
      bio: author.bio,
      slug: author.slug,
      image: author.image,
      twitterUrl: author.twitterUrl,
      facebookUrl: author.facebookUrl,
      linkedInUrl: author.linkedInUrl,
    })) || [],
  publishDate: webinar.date,
  summary: {
    title: webinar.title,
    description: webinar.description,
  },
  content: webinar.content,
  resources: webinar.resources || [],
  image: webinar.image,
  video: webinar.video,
  objectives:
    webinar.objectives?.map((obj) => ({
      description: obj.title,
    })) || [],
};
console.log(`ðŸ“„ Mapped webinar: "${mappedWebinar.title}" (${mappedWebinar.type})`);
---

<Layout>
  <WebinarDetailHeroSection
    type={mappedWebinar.type || "webinar"}
    title={mappedWebinar.title}
    overview={mappedWebinar.overview || mappedWebinar.description}
    tags={mappedWebinar.tags || []}
    author={mappedWebinar.author}
    publishDate={mappedWebinar.publishDate}
    availability={mappedWebinar.availability || "On-demand"}
    duration={mappedWebinar.duration || "60 minutes"}
    language={mappedWebinar.language || "English"}
    shareUrl={`/webinars/${slug}`}
    time={mappedWebinar.time || ""}
    image={mappedWebinar.image?.url || "/img/video-thumbnail.webp"}
    video={mappedWebinar.video || ""}
    webinarId={webinar.webinarId}
    zoomWebinarId={webinar.zoomWebinarId}
    joinUrl={webinar.joinUrl || webinar.zoomJoinUrl}
    client:load
  />
  <WebinarDetail
    client:load
    objectives={mappedWebinar.objectives || []}
    summary={mappedWebinar.summary}
    content={mappedWebinar.content || mappedWebinar.description || ""}
    resources={mappedWebinar.resources || []}
    authors={mappedWebinar.author}
  />
  <WebinarAuthorWrapper client:load authors={mappedWebinar.author} type={mappedWebinar.type || "webinar"} />
</Layout>
